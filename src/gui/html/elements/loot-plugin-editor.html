<!-- Fires the following events:

loot-editor-close
  detail: boolean
    True if the editor was closed using the Apply button.

-->

<link rel="import" href="../../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../../bower_components/iron-pages/iron-pages.html">

<link rel="import" href="../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../../../bower_components/paper-tooltip/paper-tooltip.html">

<link rel="import" href="editable-table.html">
<link rel="import" href="loot-custom-icons.html">

<dom-module id="loot-plugin-editor">
  <template>
    <style>
      /* Material Design for non-button icons. */
      iron-icon {
        color: var(--loot-secondary-text-color);
        padding: 8px;
      }

      /* Icon styling. */
      [hidden] {
        display: none;
      }
      #activeTick {
        color: green;
      }
      #activeTick[hidden] {
        display: initial;
        visibility: hidden;
      }
      #accept {
        color: var(--loot-accent-color);
      }
      #cancel {
        color: red;
      }

      /* Content styling. */
      ::content h1, #version, #crc {
        display: inline-block;
        font-weight: 400;
        font-size: 1rem;
      }
      ::content h1 {
        margin: 0;
        font-size: 1.143rem;
      }
      #version {
        margin-left: 16px;
        color: #607D8B;
      }
      #crc {
        margin-left: 16px;
        color: #795548;
      }

      /* Editor input styling. */
      #main > div {
        height: 48px;
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }
      #main > div > div:first-child {
        margin-right: 16px;
        @apply(--layout-flex);
      }
      iron-pages > *:not(.iron-selected) {
        display: none;
      }

      /* Misc Styling. */
      paper-toolbar.medium-tall {
        --paper-toolbar-background: #CFD4E9;
        --paper-toolbar-color: var(--loot-primary-text-color);
        height: 104px;
      }
      iron-pages > * {
        border: 4px solid #CFD4E9;
        border-top: none;
        background: white;
        margin-bottom: 4px;
      }
      #main {
        padding: 16px;
        overflow: hidden;
      }
      iron-pages > div > table[is=editable-table] th {
        padding-top: 8px;
        padding-bottom: 8px;
      }
      #title {
        @apply(--layout-flex);
        overflow: hidden;
        white-space: nowrap;
      }
      #tableTabs {
        --paper-tabs-selection-bar-color: var(--loot-accent-color);
      }
      paper-tab {
        --paper-tab-ink: var(--loot-accent-color);
      }
    </style>
    <paper-toolbar class="medium-tall">
      <iron-icon id="activeTick" icon="check"></iron-icon>
      <paper-tooltip for="activeTick">Active Plugin</paper-tooltip>
      <div id="title">
        <content select="h1"></content>
        <span id="version">
          <content select=".version"></content>
        </span>
        <span id="crc">
          <content select=".crc"></content>
        </span>
      </div>
      <iron-icon id="isMaster" icon="loot-custom-icons:crown"></iron-icon>
      <paper-tooltip for="isMaster">Master File</paper-tooltip>
      <iron-icon id="isEmpty" icon="visibility-off"></iron-icon>
      <paper-tooltip for="isEmpty">Empty Plugin</paper-tooltip>
      <iron-icon id="loadsArchive" icon="attachment"></iron-icon>
      <paper-tooltip for="loadsArchive">Loads Archive</paper-tooltip>
      <paper-icon-button id="accept" icon="check"></paper-icon-button>
      <paper-tooltip for="accept">Apply</paper-tooltip>
      <paper-icon-button id="cancel" icon="close"></paper-icon-button>
      <paper-tooltip for="cancel">Cancel</paper-tooltip>
      <paper-tabs id="tableTabs" class="bottom fit" selected="{{selected}}" attr-for-selected="data-for" scrollable>
        <paper-tab data-for="main">Main</paper-tab>
        <paper-tab data-for="after">Load After</paper-tab>
        <paper-tab data-for="req">Requirements</paper-tab>
        <paper-tab data-for="inc">Incompatibilities</paper-tab>
        <paper-tab data-for="message">Messages</paper-tab>
        <paper-tab data-for="tags">Bash Tags</paper-tab>
        <paper-tab data-for="dirty">Dirty Info</paper-tab>
        <paper-tab data-for="url">Locations</paper-tab>
      </paper-tabs>
    </paper-toolbar>
    <iron-pages id="tablePages" selected="{{selected}}" attr-for-selected="id">
      <div id="main">
        <div>
          <div>Enable Edits</div>
          <paper-toggle-button id="enableEdits"></paper-toggle-button>
        </div>
        <div>
          <div>Global Priority</div>
          <paper-toggle-button id="isPriorityGlobal"></paper-toggle-button>
          <paper-tooltip for="isPriorityGlobal">Compare against all other plugins, not just conflicting plugins.</paper-tooltip>
        </div>
        <div>
          <div>Priority Value</div>
          <paper-input id="priorityValue" type="number" max="999999" min="-999999" step="1" prevent-invalid-input no-label-float></paper-input>
        </div>
      </div>
      <div id="after">
        <table is="editable-table" data-template="fileRow">
          <thead>
            <tr><th>Filename</th><th>Display Name</th><th>Condition</th><th></th></tr>
          </thead>
          <tbody>
            <!-- File rows go here. -->
          </tbody>
        </table>
      </div>
      <div id="req">
        <table is="editable-table" data-template="fileRow">
          <thead>
            <tr><th>Filename</th><th>Display Name</th><th>Condition</th><th></th></tr>
          </thead>
          <tbody>
            <!-- File rows go here. -->
          </tbody>
        </table>
      </div>
      <div id="inc">
        <table is="editable-table" data-template="fileRow">
          <thead>
            <tr><th>Filename</th><th>Display Name</th><th>Condition</th><th></th></tr>
          </thead>
          <tbody>
            <!-- File rows go here. -->
          </tbody>
        </table>
      </div>
      <div id="message">
        <table is="editable-table" data-template="messageRow">
          <thead>
            <tr><th>Type</th><th>Content</th><th>Condition</th><th>Language</th><th></th></tr>
          </thead>
          <tbody>
            <!-- Message rows go here. -->
          </tbody>
        </table>
      </div>
      <div id="tags">
        <table is="editable-table" data-template="tagRow">
          <thead>
            <tr><th>Add/Remove</th><th>Bash Tag</th><th>Condition</th><th></th></tr>
          </thead>
          <tbody>
            <!-- Bash Tag rows go here. -->
          </tbody>
        </table>
      </div>
      <div id="dirty">
        <table is="editable-table" data-template="dirtyInfoRow">
          <thead>
            <tr><th>CRC</th><th>ITM Count</th><th>Deleted References</th><th>Deleted Navmeshes</th><th>Cleaning Utility</th><th></th></tr>
          </thead>
          <tbody>
            <!-- Dirty info rows go here. -->
          </tbody>
        </table>
      </div>
      <div id="url">
        <table is="editable-table" data-template="locationRow">
          <thead>
            <tr><th>URL</th><th>Name</th><th></th></tr>
          </thead>
          <tbody>
            <!-- Location rows go here. -->
          </tbody>
        </table>
      </div>
    </iron-pages>
  </template>
  <script>
    'use strict';
    Polymer({ // eslint-disable-line new-cap, no-undef
      is: 'loot-plugin-editor',
      properties: {
        selected: {
          type: String,
          value: 'main',
        },
      },

      attached() {
        this.$.accept.addEventListener('click', this._onHideEditor);
        this.$.cancel.addEventListener('click', this._onHideEditor);
        this.$.tablePages.addEventListener('iron-deselect', this._onTablePageActivate);
      },

      detached() {
        this.$.accept.removeEventListener('click', this._onHideEditor);
        this.$.cancel.removeEventListener('click', this._onHideEditor);
        this.$.tablePages.removeEventListener('iron-deselect', this._onTablePageActivate);
      },

      _onTablePageActivate() {
        /* Notify that this editor (may have) changed size. */
        this.dispatchEvent(new CustomEvent('iron-resize', { bubbles: true }));
      },

      _rowDataToMessage(rowData) {
        return {
          type: rowData.type,
          content: [{
            str: rowData.content,
            lang: rowData.language,
          }],
          condition: rowData.condition,
        };
      },

      _rowDataToCrc(rowData) {
        return {
          crc: parseInt(rowData.crc, 16),
          itm: rowData.itm,
          udr: rowData.udr,
          nav: rowData.nav,
          util: rowData.util,
        };
      },

      readFromEditor(oldData) {
        /* Need to turn all the editor controls' values into data to
           process. The control values can be compared with the existing
           values to determine what's been changed, and masterlist rows in
           the tables can be ignored because they're immutable. */

        const plugin = {
          name: this.querySelector('h1').textContent,
          userlist: {},
        };

        /* If either of the priority values have been changed, the
           base priority value they're derived from will have
           changed, so record both. */
        if (this.$.isPriorityGlobal.checked !== oldData.isPriorityGlobal
            || this.$.priorityValue.value !== oldData.priority) {
          plugin.isPriorityGlobal = this.$.isPriorityGlobal.checked;
          plugin.priority = this.$.priorityValue.value;

          /* Also mark the priority as being explicitly set in the userlist. */
          plugin.userlist.hasExplicitPriority = true;
        }

        plugin.userlist.enabled = this.$.enableEdits.checked;

        const tables = this.shadowRoot.querySelectorAll('table');
        for (let j = 0; j < tables.length; ++j) {
          const rowsData = tables[j].getRowsData(true);
          if (rowsData.length > 0) {
            if (tables[j].parentElement.id === 'after') {
              plugin.userlist.after = rowsData;
            } else if (tables[j].parentElement.id === 'req') {
              plugin.userlist.req = rowsData;
            } else if (tables[j].parentElement.id === 'inc') {
              plugin.userlist.inc = rowsData;
            } else if (tables[j].parentElement.id === 'message') {
              plugin.userlist.msg = rowsData.map(this._rowDataToMessage);
            } else if (tables[j].parentElement.id === 'tags') {
              plugin.userlist.tag = rowsData.map(loot.Plugin.tagFromRowData);
            } else if (tables[j].parentElement.id === 'dirty') {
              plugin.userlist.dirty = rowsData.map(this._rowDataToCrc);
            } else if (tables[j].parentElement.id === 'url') {
              plugin.userlist.url = rowsData;
            }
          }
        }

        return plugin;
      },

      _onHideEditor(evt) {
        /* First validate table inputs. */
        let isValid = true;
        const inputs = evt.target.parentElement.parentNode.querySelectorAll('paper-input');
        for (let i = 0; i < inputs.length; ++i) {
          if (!inputs[i].validate()) {
            isValid = false;
          }
        }

        if (isValid || evt.target.id !== 'accept') {
          /* Fire the close event, saying whether or not to save data. */
          evt.target.dispatchEvent(new CustomEvent('loot-editor-close', {
            detail: evt.target.id === 'accept',
            bubbles: true,
          }));
        }
      },

      _messageToRowData(message) {
        return {
          type: message.type,
          content: message.content[0].str,
          condition: message.condition,
          language: message.content[0].lang,
        };
      },

      _dirtyInfoToRowData(dirtyInfo) {
        return {
          crc: dirtyInfo.crc.toString(16).toUpperCase(),
          itm: dirtyInfo.itm,
          udr: dirtyInfo.udr,
          nav: dirtyInfo.nav,
          util: dirtyInfo.util,
        };
      },

      setEditorData(newData) {
        /* newData is a Plugin object reference. */

        /* First update the header icons. */
        this.$.activeTick.hidden = !newData.isActive;
        this.$.isMaster.hidden = !newData.isMaster;
        this.$.isEmpty.hidden = !newData.isEmpty;
        this.$.loadsArchive.hidden = !newData.loadsArchive;

        /* There may be existing recorded data from a previous instance of the
           editor, so use that for userlist and priority data if so. */
        let tempData = {};
        if (newData.editor) {
          if (newData.editor.isPriorityGlobal) {
            tempData.isPriorityGlobal = newData.editor.isPriorityGlobal;
          }
          if (newData.editor.priority) {
            tempData.priority = newData.editor.priority;
          }
          tempData.userlist = newData.editor.userlist;
        } else {
          tempData = {
            isPriorityGlobal: newData.isPriorityGlobal,
            priority: newData.priority,
            userlist: newData.userlist,
          };
        }

        /* Fill in the version and CRC values. */
        this.shadowRoot.getElementById('version').textContent = newData.getCardContent(loot.filters).version;
        this.shadowRoot.getElementById('crc').textContent = newData.getCardContent(loot.filters).crc;

        /* Fill in the editor input values. */
        if (tempData.userlist && !tempData.userlist.enabled) {
          this.$.enableEdits.checked = false;
        } else {
          this.$.enableEdits.checked = true;
        }
        this.$.isPriorityGlobal.checked = tempData.isPriorityGlobal;
        this.$.priorityValue.value = tempData.priority;

        /* Clear then fill in editor table data. Masterlist-originated
           rows should have their contents made read-only. */
        const tables = this.shadowRoot.querySelectorAll('table');
        for (let j = 0; j < tables.length; ++j) {
          tables[j].clear();
          if (tables[j].parentElement.id === 'message') {
            if (newData.masterlist && newData.masterlist.msg) {
              newData.masterlist.msg.map(this._messageToRowData).forEach(tables[j].addReadOnlyRow, tables[j]);
            }
            if (tempData.userlist && tempData.userlist.msg) {
              tempData.userlist.msg.map(this._messageToRowData).forEach(tables[j].addRow, tables[j]);
            }
          } else if (tables[j].parentElement.id === 'tags') {
            if (newData.masterlist && newData.masterlist.tag) {
              newData.masterlist.tag.map(loot.Plugin.tagToRowData).forEach(tables[j].addReadOnlyRow, tables[j]);
            }
            if (tempData.userlist && tempData.userlist.tag) {
              tempData.userlist.tag.map(loot.Plugin.tagToRowData).forEach(tables[j].addRow, tables[j]);
            }
          } else if (tables[j].parentElement.id === 'dirty') {
            if (newData.masterlist && newData.masterlist.dirty) {
              newData.masterlist.dirty.map(this._dirtyInfoToRowData).forEach(tables[j].addReadOnlyRow, tables[j]);
            }
            if (tempData.userlist && tempData.userlist.dirty) {
              tempData.userlist.dirty.map(this._dirtyInfoToRowData).forEach(tables[j].addReadOnlyRow, tables[j]);
            }
          } else {
            if (newData.masterlist && newData.masterlist[tables[j].parentElement.id]) {
              newData.masterlist[tables[j].parentElement.id].forEach(tables[j].addReadOnlyRow, tables[j]);
            }
            if (tempData.userlist && tempData.userlist[tables[j].parentElement.id]) {
              tempData.userlist[tables[j].parentElement.id].forEach(tables[j].addRow, tables[j]);
            }
          }
        }
      },
    });
  </script>
</dom-module>
