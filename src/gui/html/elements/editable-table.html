<link rel="import" href="../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../bower_components/polymer/lib/utils/render-status.html">

<link rel="import" href="../../../../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="../../../../bower_components/paper-autocomplete/paper-autocomplete.html">
<link rel="import" href="../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../../bower_components/paper-tooltip/paper-tooltip.html">

<link rel="import" href="loot-dropdown-menu.html">

<template id="fileRow">
  <tr>
    <td><paper-autocomplete error-message="A filename is required." class="name" required auto-validate no-label-float></paper-autocomplete></td>
    <td><paper-input class="display" no-label-float></paper-input></td>
    <td><paper-input class="condition" no-label-float></paper-input></td>
    <td>
      <span>
        <paper-icon-button class="delete" icon="delete"></paper-icon-button>
        <paper-tooltip position="left">Delete Row</paper-tooltip>
      </span>
    </td>
  </tr>
</template>
<template id="messageRow">
  <tr>
    <td style="width: 100px;">
      <loot-dropdown-menu class="type" value="say" no-label-float>
        <paper-item value="say">Note</paper-item>
        <paper-item value="warn">Warning</paper-item>
        <paper-item value="error">Error</paper-item>
      </loot-dropdown-menu>
    </td>
    <td><paper-input error-message="A content string is required." class="text" required auto-validate no-label-float></paper-input></td>
    <td><paper-input class="condition" no-label-float></paper-input></td>
    <td>
      <loot-dropdown-menu class="language" no-label-float>
        <!-- Language <option> elements go here. -->
      </loot-dropdown-menu>
    </td>
    <td>
      <span>
        <paper-icon-button class="delete" icon="delete"></paper-icon-button>
        <paper-tooltip position="left">Delete Row</paper-tooltip>
      </span>
    </td>
  </tr>
</template>
<template id="tagRow">
  <tr>
    <td style="width: 100px;">
      <loot-dropdown-menu class="type" value="add" no-label-float>
        <paper-item value="add">Add</paper-item>
        <paper-item value="remove">Remove</paper-item>
      </loot-dropdown-menu>
    </td>
    <td><paper-autocomplete error-message="A name is required." class="name" required auto-validate no-label-float></paper-autocomplete></td>
    <td><paper-input class="condition" no-label-float></paper-input></td>
    <td>
      <span>
        <paper-icon-button class="delete" icon="delete"></paper-icon-button>
        <paper-tooltip position="left">Delete Row</paper-tooltip>
      </span>
    </td>
  </tr>
</template>
<template id="dirtyInfoRow">
  <tr>
    <td style="width: 104px;"><paper-input error-message="A CRC is required." class="crc" maxlength="8" minlength="8" pattern="[0-9A-Fa-f]{8}" required auto-validate no-label-float></paper-input></td>
    <td style="width: 48px;"><paper-input error-message="Values must be integers." class="itm" type="number" min="0" step="1" value="0" auto-validate no-label-float></paper-input></td>
    <td style="width: 48px;"><paper-input error-message="Values must be integers." class="udr" type="number" min="0" step="1" value="0" auto-validate no-label-float></paper-input></td>
    <td style="width: 48px;"><paper-input error-message="Values must be integers." class="nav" type="number" min="0" step="1" value="0" auto-validate no-label-float></paper-input></td>
    <td><paper-input error-message="A utility name is required." class="utility" required auto-validate no-label-float></paper-input></td>
    <td>
      <span>
        <paper-icon-button class="delete" icon="delete"></paper-icon-button>
        <paper-tooltip position="left">Delete Row</paper-tooltip>
      </span>
    </td>
  </tr>
</template>
<template id="cleanInfoRow">
  <tr>
    <td style="width: 92px;"><paper-input error-message="A CRC is required." class="crc" maxlength="8" minlength="8" pattern="[0-9A-Fa-f]{8}" required auto-validate no-label-float></paper-input></td>
    <td><paper-input error-message="A utility name is required." class="utility" required auto-validate no-label-float></paper-input></td>
    <td>
      <span>
        <paper-icon-button class="delete" icon="delete"></paper-icon-button>
        <paper-tooltip position="left">Delete Row</paper-tooltip>
      </span>
    </td>
  </tr>
</template>
<template id="locationRow">
  <tr>
    <td><paper-input error-message="A link is required." class="link" required auto-validate no-label-float></paper-input></td>
    <td><paper-input class="name" no-label-float></paper-input></td>
    <td>
      <span>
        <paper-icon-button class="delete" icon="delete"></paper-icon-button>
        <paper-tooltip position="left">Delete Row</paper-tooltip>
      </span>
    </td>
  </tr>
</template>
<template id="gameRow">
  <tr>
    <td><paper-input error-message="A name is required." class="name" required auto-validate no-label-float></paper-input></td>
    <td>
      <loot-dropdown-menu class="type" no-label-float>
        <!-- Game <option> elements go here. -->
      </loot-dropdown-menu>
    </td>
    <td><paper-input error-message="A folder is required." class="folder" required auto-validate no-label-float></paper-input></td>
    <td><paper-input class="master" no-label-float></paper-input></td>
    <td><paper-input class="repo" no-label-float></paper-input></td>
    <td><paper-input class="branch" no-label-float></paper-input></td>
    <td><paper-input class="path" no-label-float></paper-input></td>
    <td><paper-input class="registry" no-label-float></paper-input></td>
    <td>
      <span>
        <paper-icon-button class="delete" icon="delete"></paper-icon-button>
        <paper-tooltip position="left">Delete Row</paper-tooltip>
      </span>
    </td>
  </tr>
</template>
<template id="newRow">
  <tr>
    <td>
      <span>
        <paper-icon-button icon="add"></paper-icon-button>
        <paper-tooltip position="right">Add New Row</paper-tooltip>
      </span>
    </td>
    <td></td>
  </tr>
</template>

<style>

editable-table td,
editable-table th {
  vertical-align: middle;
  text-align: left;
  padding: 0 7px;
}
editable-table th:first-child,
editable-table td:first-child {
  padding-left: 16px;
}
editable-table th:last-child,
editable-table td:last-child {
  padding-left: 0;
}
editable-table thead > tr {
  height: 56px;
}
editable-table tbody > tr {
  height: 48px;
}
editable-table th {
    color: var(--secondary-text-color);
    border-bottom: 1px solid var(--divider-color);
}
editable-table paper-icon-button {
    color: var(--secondary-text-color);
}
editable-table paper-icon-button[disabled] {
    color: var(--disabled-text-color);
}
editable-table paper-icon-button[icon=delete]:hover {
    color: red;
}
editable-table paper-icon-button[icon=add]:hover {
    color: green;
}
</style>
<dom-module id="editable-table">
  <template>
    <style>
      :host {
          background-color: inherit;
          border-collapse: collapse;
          width: 100%;
      }
    </style>
    <slot>
    </slot>
  </template>
  <script>
    'use strict';
    const editableTableHtml = document.currentScript.ownerDocument;
    function getRowTemplate(templateId) {
      return editableTableHtml.getElementById(templateId);
    }

    class EditableTable extends Polymer.Element {
      static get is() { return 'editable-table' }

      connectedCallback() {
        super.connectedCallback();

        Polymer.RenderStatus.beforeNextRender(this, () => {
          /* Add "add new row" row. */
          const content = getRowTemplate('newRow').content;
          let row = document.importNode(content, true);
          this.querySelector('tbody').appendChild(row);
          row = this.querySelector('tbody').lastElementChild;

          /* Add new row listener. */
          row.querySelector('paper-icon-button').addEventListener('click', this.onAddEmptyRow);

          /* Add drag 'n' drop listeners.
             Drag 'n' drop should only be enabled for file-row tables.
          */
          if (this.getAttribute('data-template') === 'fileRow') {
            this.addEventListener('drop', this.onDrop);
            this.addEventListener('dragover', this.onDragOver);
          }
        });
      }

      disconnectedCallback() {
        super.disconnectedCallback();

        /* Remove deletion listener. */
        const icons = this.querySelector('tbody').getElementsByClassName('delete');
        for (let i = 0; i < icons.length; ++i) {
          icons[i].removeEventListener('click', this.onRemoveRow);
        }

        /* Remove new row listener. */
        this.querySelector('tbody tr:last-child paper-icon-button').removeEventListener('click', this.onAddEmptyRow);

        /* Remove drag 'n' drop listeners. */
        this.removeEventListener('drop', this.onDrop);
        this.removeEventListener('dragover', this.onDragOver);
      }

      onDrop(evt) {
        evt.stopPropagation();

        if (evt.currentTarget.tagName === 'EDITABLE-TABLE'
            && evt.currentTarget.getAttribute('data-template') === 'fileRow') {
          evt.currentTarget.addRow({
            name: evt.dataTransfer.getData('text/plain'),
          });
        }

        return false;
      }

      onDragOver(evt) {
        evt.preventDefault();
        evt.dataTransfer.dropEffect = 'copy';
      }

      getRowsData(writableOnly) {
        const writableRows = [];
        const rows = this.querySelector('tbody').rows;

        for (let i = 0; i < rows.length; ++i) {
          const trash = rows[i].getElementsByClassName('delete');
          if (trash.length > 0 && (!writableOnly || !trash[0].disabled)) {
            const rowData = {};

            const inputs = rows[i].querySelectorAll('paper-autocomplete, paper-input, paper-textarea, loot-dropdown-menu');
            for (let j = 0; j < inputs.length; ++j) {
              rowData[inputs[j].className] = inputs[j].value;
            }
            const autocompletes = rows[i].getElementsByTagName('paper-autocomplete');
            for (let j = 0; j < autocompletes.length; j += 1) {
              rowData[autocompletes[j].className] = autocompletes[j].text;
            }

            writableRows.push(rowData);
          }
        }

        return writableRows;
      }

      setReadOnly(row, classMask, readOnly) {
        readOnly = readOnly || true;

        const trash = row.getElementsByClassName('delete')[0];
        if (classMask) {
          if (classMask.indexOf('delete') !== -1) {
            trash.disabled = readOnly;
          }
        } else {
          trash.disabled = readOnly;
        }

        const inputs = row.querySelectorAll('paper-autocomplete, paper-input, paper-textarea, loot-dropdown-menu');
        for (let i = 0; i < inputs.length; ++i) {
          if (classMask) {
            for (let j = 0; j < classMask.length; ++j) {
              if (inputs[i].classList.contains(classMask[j])) {
                inputs[i].disabled = readOnly;
                break;
              }
            }
          } else {
            inputs[i].disabled = readOnly;
          }
        }
      }

      clear() {
        const rowDeletes = this.querySelector('tbody').getElementsByClassName('delete');
        while (rowDeletes.length > 0) {
          rowDeletes[0].click();
        }
      }

      onRemoveRow(evt) {
        const tr = evt.target.parentElement.parentElement.parentElement;
        const tbody = tr.parentElement;
        const table = tbody.parentElement;

        /* Remove deletion listener. */
        evt.target.removeEventListener('click', table.parentElement.onRemoveRow);

        /* Now remove row. */
        tbody.removeChild(tr);

        /* Notify that the table size has changed. */
        this.dispatchEvent(new CustomEvent('iron-resize', {
          bubbles: true,
          composed: true,
        }));
      }

      onAddEmptyRow(evt) {
        evt.currentTarget.parentElement.parentElement.parentElement.parentElement.parentElement.parentElement.addRow({});

        /* Notify that the table size has changed. */
        this.dispatchEvent(new CustomEvent('iron-resize', {
          bubbles: true,
          composed: true,
        }));
      }

      addRow(tableData) {
        const rowTemplateId = this.getAttribute('data-template');
        const content = getRowTemplate(rowTemplateId).content;
        let row = document.importNode(content, true);
        this.querySelector('tbody').insertBefore(row, this.querySelector('tbody').lastElementChild);
        row = this.querySelector('tbody').lastElementChild.previousElementSibling;

        /* Data is an object with keys that match element class names. */
        for (const key in tableData) {
          const elems = row.getElementsByClassName(key);
          if (tableData[key] !== undefined && elems.length === 1) {
            if (elems[0].tagName === 'PAPER-AUTOCOMPLETE') {
              elems[0].text = tableData[key];
            } else {
              elems[0].value = tableData[key];
            }
          }
        }

        /* Add deletion listener. */
        row.getElementsByClassName('delete')[0].addEventListener('click', this.onRemoveRow);

        /* Notify that the table size has changed. */
        this.dispatchEvent(new CustomEvent('iron-resize', {
          bubbles: true,
          composed: true,
        }));

        return row;
      }

      addReadOnlyRow(tableData) {
        this.setReadOnly(this.addRow(tableData));
      }

      validate() {
        const inputs = this.querySelectorAll('paper-autocomplete, paper-input, paper-textarea');
        for (let i = 0; i < inputs.length; ++i) {
          if (!inputs[i].validate()) {
            return false;
          }
        }
        return true;
      }
    }

    customElements.define(EditableTable.is, EditableTable);
  </script>
</dom-module>
