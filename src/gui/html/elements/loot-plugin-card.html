<!-- Fires the following events:

loot-editor-open

loot-filter-conflicts
  detail: boolean
    True if the filter has been activated.

loot-copy-metadata

loot-clear-metadata
-->

<link rel="import" href="../../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../../../bower_components/paper-tooltip/paper-tooltip.html">

<link rel="import" href="loot-plugin-editor.html">
<link rel="import" href="loot-custom-icons.html">
<link rel="import" href="loot-menu.html">

<dom-module id="loot-plugin-card">
  <template>
    <style>
      /* Host and front/editor styling. */
      #wrapper {
        display: block;
        background: white;
        margin: 0 8px 8px 8px;
        position: relative;
        transition: 0.6s;
        transform-style: preserve-3d;
      }
      :host(.highlight) #wrapper {
        outline: 4px solid var(--loot-accent-color);
      }
      :host([is-search-result]) #front,
      :host([is-search-result]) #editor {
        box-shadow: inset 4px 0 var(--loot-primary-color);
      }
      #front {
        display: block;
        backface-visibility: hidden;
      }
      #editor {
        transform: rotateY(180deg);
        display:none;
        backface-visibility: hidden;
      }

      /* Flip animation styling. */
      :host(.flip) #wrapper {
        transform: rotateY(180deg);
      }
      :host(.flip) #front  {
        display: none;
      }
      :host(.flip) #editor  {
        display: block;
      }
      :host(.fastflip) #wrapper {
        transition-duration: 1ms;
      }

      /* Icon styling. */
      iron-icon {
        color: var(--loot-secondary-text-color);
        padding: 8px;
      }
      #activeTick {
        color: green;
      }
      :host(:not([is-active])) #activeTick {
        visibility: hidden;
      }

      /* Content styling. */
      content::content > .tag {
        display: block;
        padding: 0 16px 16px;
      }
      content::content > ul {
        display: block;
        padding: 0 16px 16px 40px;
        margin: 0;
      }
      content::content > h1 {
        font-size: 1.143rem;
        display: inline-block;
        margin: 0;
        color: inherit;
      }
      content::content > .version,
      content::content > .crc {
        display: inline-block;
        margin-left: 16px;
        font-weight: 400;
        font-size: 1rem;
      }

      /* Misc Styling. */
      paper-toolbar {
        --paper-toolbar-color: var(--loot-primary-text-color);
        --paper-toolbar-background: inherit;
      }
      #content {
        overflow: hidden;
      }
      #title {
        @apply(--layout-flex);
        overflow: hidden;
        white-space: nowrap;
      }
      #editMetadata,
      #copyMetadata,
      #clearMetadata {
        cursor: pointer;
      }
      #showOnlyConflicts {
        min-height: 48px;
        padding: 0 16px;
        font-weight: 500;
        --paper-toggle-button-label-spacing: 16px;
        white-space: nowrap;
      }
      [hidden] {
        display: none;
      }
    </style>
    <paper-material id="wrapper" elevation="1">
      <section id="front">
        <paper-toolbar>
          <iron-icon id="activeTick" icon="check"></iron-icon>
          <paper-tooltip for="activeTick">Active Plugin</paper-tooltip>
          <div id="title">
            <content select="h1"></content>
            <content select=".version"></content>
            <content select=".crc"></content>
          </div>
          <iron-icon id="isMaster" icon="loot-custom-icons:crown" hidden$="[[!isMaster]]"></iron-icon>
          <paper-tooltip for="isMaster">Master File</paper-tooltip>
          <iron-icon id="emptyPlugin" icon="visibility-off" hidden$="[[!isEmpty]]"></iron-icon>
          <paper-tooltip for="emptyPlugin">Empty Plugin</paper-tooltip>
          <iron-icon id="loadsArchive" icon="attachment" hidden$="[[!loadsArchive]]"></iron-icon>
          <paper-tooltip for="loadsArchive">Loads Archive</paper-tooltip>
          <iron-icon id="hasUserEdits" icon="account-circle" hidden$="[[!hasUserEdits]]"></iron-icon>
          <paper-tooltip for="hasUserEdits">Has User Metadata</paper-tooltip>
          <paper-menu-button id="menu" horizontal-align="right">
            <paper-icon-button icon="more-vert" class="dropdown-trigger"></paper-icon-button>
            <loot-menu class="dropdown-content">
              <paper-toggle-button id="showOnlyConflicts" checked="{{data.isConflictFilterChecked}}">Show Only Conflicts</paper-toggle-button>
              <paper-icon-item id="editMetadata">
                <iron-icon icon="create" item-icon></iron-icon>
                Edit Metadata
              </paper-icon-item>
              <paper-icon-item id="copyMetadata">
                <iron-icon icon="content-copy" item-icon></iron-icon>
                Copy Metadata
              </paper-icon-item>
              <paper-icon-item id="clearMetadata">
                <iron-icon icon="delete" item-icon></iron-icon>
                Clear User Metadata
              </paper-icon-item>
            </loot-menu>
          </paper-menu-button>
        </paper-toolbar>
        <div id="content">
          <content select=".tag.add"></content>
          <content select=".tag.remove"></content>
          <content></content>
        </div>
      </section>
      <loot-plugin-editor id="editor">
        <h1>[[data.name]]</h1>
        <span class="version"></span>
        <span class="crc"></span>
      </loot-plugin-editor>
    </paper-material>
  </template>
  <script>
    'use strict';
    function getMenuItemCard(element) {
      while (element.parentElement) {
        element = element.parentElement;
      }
      return element.parentNode.host;
    }

    Polymer({
      is: 'loot-plugin-card',
      properties: {
        data: {
          notify: true,
          observer: '_dataChanged',
        },
        isActive: {
          type: Boolean,
          value: false,
          reflectToAttribute: true,
        },
        isMaster: {
          type: Boolean,
          value: false,
          reflectToAttribute: true,
        },
        isEmpty: {
          type: Boolean,
          value: false,
          reflectToAttribute: true,
        },
        loadsArchive: {
          type: Boolean,
          value: false,
          reflectToAttribute: true,
        },
        hasUserEdits: {
          type: Boolean,
          value: false,
          reflectToAttribute: true,
        },
        isSearchResult: {
          type: Boolean,
          value: false,
          reflectToAttribute: true,
        },
      },

      attached() {
        this.$.showOnlyConflicts.addEventListener('change', this._onShowOnlyConflicts);
        this.$.editMetadata.addEventListener('click', this.onShowEditor);
        this.$.editor.addEventListener('loot-editor-close', this._onHideEditor);
        this.$.copyMetadata.addEventListener('click', this._onCopyMetadata);
        this.$.clearMetadata.addEventListener('click', this._onClearMetadata);

        this.addEventListener('transitionend', this._onFlipEnd);
      },

      detached() {
        this.$.showOnlyConflicts.removeEventListener('change', this._onShowOnlyConflicts);
        this.$.editMetadata.removeEventListener('click', this.onShowEditor);
        this.$.editor.removeEventListener('loot-editor-close', this._onHideEditor);
        this.$.copyMetadata.removeEventListener('click', this._onCopyMetadata);
        this.$.clearMetadata.removeEventListener('click', this._onClearMetadata);

        this.removeEventListener('transitionend', this._onFlipEnd);
      },

      _dataChanged(newValue, oldValue) {
        if (newValue) {
          if (newValue.isEditorOpen) {
            /* Record existing data. */
            if (oldValue) {
              oldValue.editor = this.readFromEditor(oldValue);
            }
            /* Share the data with the editor. */
            this.$.editor.setEditorData(newValue);
          }

          /* Set the card flip state. */
          if (this.classList.contains('flip') !== newValue.isEditorOpen) {
            /* Temporarily speed up the flip effect, as otherwise fast
               scrolling lets the user see the end of it. */
            this.classList.add('fastflip');
            this.classList.toggle('flip');
          }

          /* Initialise the card content data. */
          this.updateContent();

          /* Also set highlight if the conflict filter is active. */
          this.classList.toggle('highlight', newValue.isConflictFilterChecked);

          /* Set highlight if the plugin is a search result. */
          this.classList.toggle('search-result', newValue.isSearchResult);
        }
      },

      _setTagsContent(tags) {
        if (tags) {
          const tagsAdded = this.getElementsByClassName('tag add')[0];
          tagsAdded.textContent = tags.added;
          tagsAdded.hidden = tags.added.length === 0;

          const tagsRemoved = this.getElementsByClassName('tag remove')[0];
          tagsRemoved.textContent = tags.removed;
          tagsRemoved.hidden = tags.removed.length === 0;
        }
      },

      _setMessagesContent(messages) {
        /* First clear any existing messages. */
        const messageList = this.getElementsByTagName('ul')[0];
        while (messageList.firstElementChild) {
          messageList.removeChild(messageList.firstElementChild);
        }

        if (messages) {
          /* Now add new messages. */
          messages.forEach((message) => {
            const messageListItem = document.createElement('li');
            messageListItem.className = message.type;
            // Use the Marked library for Markdown formatting support.
            messageListItem.innerHTML = window.marked(message.content);
            messageList.appendChild(messageListItem);
          });
          messageList.hidden = messages.length === 0;
        }
      },

      updateContent() {
        if (this.data) {
          const cardContent = this.data.getCardContent(loot.filters);

          this.getElementsByClassName('version')[0].textContent = cardContent.version;
          this.$.editor.getElementsByClassName('version')[0].textContent = cardContent.version;

          this.getElementsByClassName('crc')[0].textContent = cardContent.crc;
          this.$.editor.getElementsByClassName('crc')[0].textContent = cardContent.crc;

          this._setTagsContent(cardContent.tags);
          this._setMessagesContent(cardContent.messages);

          this.hasUserEdits = this.data.hasUserEdits;
          this.isSearchResult = this.data.isSearchResult;

          /* Update the conflict filter toggle state. */
          this.$.showOnlyConflicts.checked = this.data.isConflictFilterChecked;

          /* Notify that this card (may have) changed size. */
          this.dispatchEvent(new CustomEvent('iron-resize', { bubbles: true }));
        }
      },

      getName() {
        return this.getElementsByTagName('h1')[0].textContent;
      },

      _onFlipEnd() {
        /* Remove fastflip class if present. This also fires when the menu is
           opened or closed, but that isn't an issue. */
        this.classList.remove('fastflip');
      },

      onShowEditor() {
        let card;
        if (this.tagName === 'LOOT-PLUGIN-CARD') {
          card = this;
        } else {
          card = getMenuItemCard(this);
        }

        /* If the editor hasn't already been opened, its data is not yet set, so do that now. */
        if (!card.data.isEditorOpen && !card.data.editor) {
          card.$.editor.setEditorData(card.data);
        }

        card.data.isEditorOpen = true;

        card.classList.toggle('flip');

        /* Fire an open event, so that the UI can enter edit mode. */
        card.dispatchEvent(new CustomEvent('loot-editor-open', {
          bubbles: true,
        }));

        /* Notify that this card (may have) changed size. */
        card.dispatchEvent(new CustomEvent('iron-resize', { bubbles: true }));
      },

      _onHideEditor() {
        let card;
        if (this.tagName === 'LOOT-PLUGIN-CARD') {
          card = this;
        } else {
          card = getMenuItemCard(this);
        }

        /* Now hide editor. */
        card.classList.toggle('flip');
        card.data.isEditorOpen = false;

        /* Notify that this card (may have) changed size. */
        card.dispatchEvent(new CustomEvent('iron-resize', { bubbles: true }));
      },

      readFromEditor(oldData) {
        return this.$.editor.readFromEditor(oldData);
      },

      _onShowOnlyConflicts(evt) {
        evt.target.dispatchEvent(new CustomEvent('loot-filter-conflicts', {
          detail: evt.currentTarget.checked,
          bubbles: true,
        }));
      },

      _onCopyMetadata(evt) {
        evt.target.dispatchEvent(new CustomEvent('loot-copy-metadata', {
          bubbles: true,
        }));
      },

      _onClearMetadata(evt) {
        evt.target.dispatchEvent(new CustomEvent('loot-clear-metadata', {
          bubbles: true,
        }));
      },
    });
  </script>
</dom-module>
