<!-- Fires the following events:

loot-editor-open

loot-filter-conflicts
  detail: boolean
    True if the filter has been activated.

loot-copy-metadata

loot-clear-metadata
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="../bower_components/core-tooltip/core-tooltip.html">
<link rel="import" href="../bower_components/core-icon/core-icon.html">
<link rel="import" href="../bower_components/core-icons/core-icons.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-dropdown/paper-dropdown.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="loot-plugin-editor.html">


<polymer-element name="loot-plugin-card">
    <template>
        <style>
        /* Host and front/editor styling. */
        #wrapper {
            display: block;
            background:white;
            margin: 0.5em 1em;
            position: relative;
            border-top-left-radius: 2px;
            border-top-right-radius: 2px;
            border-bottom-right-radius: 2px;
            border-bottom-left-radius: 2px;
            box-shadow: rgba(0, 0, 0, 0.0980392) 0px 2px 4px, rgba(0, 0, 0, 0.0980392) 0px 0px 3px;
            position: relative;
            transition: 0.6s;
            transform-style: preserve-3d;
        }
        :host([data-active=false]) #activeTick {
            visibility: hidden;
        }
        :host([data-bsa=false]) #loadsBSA {
            display: none;
        }
        :host([data-dummy=false]) #dummyPlugin {
            display: none;
        }
        :host([data-edits=false]) #hasUserEdits {
            display: none;
        }
        #front {
            padding-bottom: 1em;
        }
        #front, #editor {
            display: block;
        }
        #editor {
            transform: rotateY(180deg) translateZ(1px);
            display:none;
        }

        /* Flip animation styling. */
        :host(.flip) #wrapper {
            transform: rotateY(180deg);
        }
        :host(.flip) #front  {
            display: none;
        }
        :host(.flip) #editor  {
            display: block;
        }

        /* Icon styling. */
        #activeTick {
            color: green;
        }

        /* Content styling. */
        ::content .tag.add, ::content .tag.remove, ::content ul {
            padding: 0 1em;
        }
        ::content h1, h1 {
            font-weight: normal;
            font-size: 1em;
        }
        ::content .version, .version {
            display: inline-block;
            margin-left: 1em;
            color:#6394F8;
        }
        ::content .crc, .crc {
            display: inline-block;
            margin-left: 1em;
            color:#BC8923;
        }
        ::content .hidden, .hidden {
            display: none;
        }

        /* Misc Styling. */
        core-toolbar {
            background: white;
        }
        </style>
        <div id="wrapper">
            <section id="front">
                <core-toolbar>
                    <core-tooltip id="activeTick" label="Active Plugin">
                        <core-icon icon="check"></core-icon>
                    </core-tooltip>
                    <content select="h1"></content>
                    <content select=".version"></content>
                    <span flex><content select=".crc"></content></span>
                    <core-tooltip id="dummyPlugin" label="Dummy Plugin">
                        <core-icon icon="visibility-off"></core-icon>
                    </core-tooltip>
                    <core-tooltip id="loadsBSA" label="Loads BSA">
                        <core-icon icon="attachment"></core-icon>
                    </core-tooltip>
                    <core-tooltip id="hasUserEdits" label="Has User Metadata">
                        <core-icon icon="account-circle"></core-icon>
                    </core-tooltip>
                    <paper-menu-button>
                        <paper-icon-button icon="more-vert"></paper-icon-button>
                        <paper-dropdown class="dropdown" halign="right">
                            <div>
                                <paper-item>
                                    <paper-checkbox id="showOnlyConflicts" label="Show Only Conflicts" flex></paper-checkbox>
                                </paper-item>
                                <paper-item id="editMetadata">
                                    <core-icon icon="create"></core-icon>
                                    Edit Metadata
                                </paper-item>
                                <paper-item id="copyMetadata">
                                    <core-icon icon="content-copy"></core-icon>
                                    Copy Metadata As Text
                                </paper-item>
                                <paper-item id="clearMetadata">
                                    <core-icon icon="delete"></core-icon>
                                    Clear User Metadata
                                </paper-item>
                            </div>
                        </paper-dropdown>
                    </paper-menu-button>
                </core-toolbar>
                <content select=".tag.add"></content>
                <content select=".tag.remove"></content>
                <content select="ul"></content>
            </section>
            <loot-plugin-editor id="editor">
                <h1></h1>
                <span class="version"></span>
                <span class="crc"></span>
            </loot-plugin-editor>
        </div>
    </template>
    <script>
    Polymer({
        attached: function() {
            this.shadowRoot.getElementById('showOnlyConflicts').addEventListener('change', this.onShowOnlyConflicts, false);
            this.shadowRoot.getElementById('editMetadata').addEventListener('click', this.onShowEditor, false);
            this.shadowRoot.getElementById('copyMetadata').addEventListener('click', this.onCopyMetadata, false);
            this.shadowRoot.getElementById('clearMetadata').addEventListener('click', this.onClearMetadata, false);

            /* Because of the 3D flip effect used when accessing the editor,
               plugin menus get hidden underneath later plugin cards unless
               those cards have a lower z-index than the card the menu is part
               of. Therefore, set this card's z-index to the negative of its
               position in the plugin list.
            */
            var cards = this.parentElement.getElementsByTagName('loot-plugin-card');
            for (var i = 0; i < cards.length; ++i) {
                if (cards[i] == this) {
                    this.style.zIndex = 10000 - i;
                }
            }
        },

        detached: function() {
            this.shadowRoot.getElementById('showOnlyConflicts').removeEventListener('change', this.onShowOnlyConflicts, false);
            this.shadowRoot.getElementById('editMetadata').removeEventListener('click', this.onShowEditor, false);
            this.shadowRoot.getElementById('copyMetadata').removeEventListener('click', this.onCopyMetadata, false);
            this.shadowRoot.getElementById('clearMetadata').addEventListener('click', this.onClearMetadata, false);
        },

        getName: function() {
            return this.getElementsByTagName('h1')[0].textContent;
        },

        onShowEditor: function(evt) {
            var card = evt.target.parentElement.parentElement.parentElement.parentElement.parentElement.parentElement.parentNode.host;

            /* Fill in editor toolbar. */
            var editor = card.shadowRoot.getElementById('editor');
            editor.querySelector('h1').textContent = card.querySelector('h1').textContent;
            editor.querySelector('.version').textContent = card.querySelector('.version').textContent;
            editor.querySelector('.crc').textContent = card.querySelector('.crc').textContent;

            /* Fire an open event, so that the UI can enter edit mode. */
            card.dispatchEvent(new CustomEvent('loot-editor-open', {
                bubbles: true,
            }));
        },

        deactivateConflictFilter: function() {
            this.shadowRoot.getElementById('showOnlyConflicts').checked = false;
        },

        onShowOnlyConflicts: function(evt) {
            evt.target.dispatchEvent(new CustomEvent('loot-filter-conflicts', {
                bubbles: true,
                detail: evt.target.checked,
            }));
        },

        onCopyMetadata: function(evt) {
            evt.target.dispatchEvent(new CustomEvent('loot-copy-metadata', {
                bubbles: true,
            }));
        },

        onClearMetadata: function(evt) {
            evt.target.dispatchEvent(new CustomEvent('loot-clear-metadata', {
                bubbles: true,
            }));
        },
    });
    </script>
</polymer-element>