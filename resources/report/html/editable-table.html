<template id="fileRow">
    <tr>
        <td><input class="name" type="text" required></td>
        <td><input class="display" type="text"></td>
        <td><input class="condition" type="text"></td>
        <td class="fa fa-trash-o fa-fw"></td>
    </tr>
</template>
<template id="messageRow">
    <tr>
        <td><select class="type">
                <option value="say">Note</option>
                <option value="warn">Warning</option>
                <option value="error">Error</option>
            </select>
        </td>
        <td><input class="content" type="text" required></td>
        <td><input class="condition" type="text"></td>
        <td><select class="language">
                <!-- Language <option> elements go here. -->
            </select>
        </td>
        <td class="fa fa-trash-o fa-fw"></td>
    </tr>
</template>
<template id="tagRow">
    <tr>
        <td><select class="type">
                <option value="add">Add</option>
                <option value="remove">Remove</option>
            </select>
        </td>
        <td><input class="name" type="text" required></td>
        <td><input class="condition" type="text"></td>
        <td class="fa fa-trash-o fa-fw"></td>
    </tr>
</template>
<template id="dirtyInfoRow">
    <tr>
        <td><input class="crc" type="text" maxlength="8" minlength="8" pattern="[0-9A-Fa-f]{8}" required></td>
        <td><input class="itm" type="number" min="0" step="1" value="0"></td>
        <td><input class="udr" type="number" min="0" step="1" value="0"></td>
        <td><input class="nav" type="number" min="0" step="1" value="0"></td>
        <td><input class="util" type="text" required></td>
        <td class="fa fa-trash-o fa-fw"></td>
    </tr>
</template>
<template id="locationRow">
    <tr>
        <td><input class="link" type="text" required></td>
        <td><input class="ver" type="text"></td>
        <td class="fa fa-trash-o fa-fw"></td>
    </tr>
</template>
<template id="gameRow">
    <tr>
        <td><input class="name" type="text" required></td>
        <td>
            <select class="type">
            <!-- Game <option> elements go here. -->
            </select>
        </td>
        <td><input class="folder" type="text" required></td>
        <td><input class="master" type="text"></td>
        <td><input class="repo" type="text"></td>
        <td><input class="branch" type="text"></td>
        <td><input class="path" type="text"></td>
        <td><input class="registry" type="text"></td>
        <td class="fa fa-trash-o fa-fw"></td>
    </tr>
</template>
<style>
table[is=editable-table] td:last-child {
    cursor: pointer;
}
table[is=editable-table] td:last-child:hover {
    color: red;
}
table[is=editable-table] {
    margin: 3em 1em;
    border-collapse: collapse;
}
table[is=editable-table] td, table[is=editable-table] th {
    vertical-align: top;
    text-align: left;
    padding: 0.5em;
}
table[is=editable-table] th {
    border-bottom: 1px black solid;
}
table[is=editable-table] tbody tr:last-child {
    cursor: pointer;
    color: grey;
}
table[is=editable-table] tbody tr:last-child:hover {
    color: black;
}
</style>
<script>
'use strict';
// Record this document.
var editableTableImportDoc = document.currentScript.ownerDocument;

/* Create a <editable-table> element type that extends from <table>. */
var EditableTableProto = Object.create(HTMLTableElement.prototype, {

    handleDrop: {
        value: function(evt) {
            evt.stopPropagation();

            if (evt.currentTarget.tagName == 'TABLE' && (evt.currentTarget.id == 'req' || evt.currentTarget.id == 'inc' || evt.currentTarget.id == 'loadAfter')) {
                var data = {
                    name: evt.dataTransfer.getData('text/plain')
                };
                evt.currentTarget.addRow(data);
            }

            return false;
        }
    },

    handleDragOver: {
        value: function(evt) {
            evt.preventDefault();
            evt.dataTransfer.dropEffect = 'copy';
        }
    },

    getRowsData: {
        value: function(writableOnly) {
            var writableRows = [];
            var rows = this.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

            for (var i = 0; i < rows.length; ++i) {
                var trash = rows[i].getElementsByClassName('fa-trash-o');
                if (trash.length > 0 && (!writableOnly || !trash[0].classList.contains('hidden'))) {
                    var rowData = {};

                    var inputs = rows[i].getElementsByTagName('input');
                    for (var j = 0; j < inputs.length; ++j) {
                        rowData[inputs[j].className] = inputs[j].value;
                    }

                    var selects = rows[i].getElementsByTagName('select');
                    for (var j = 0; j < selects.length; ++j) {
                        rowData[selects[j].className] = selects[j].value;
                    }

                    writableRows.push(rowData);
                }
            }

            return writableRows;
        }
    },

    setReadOnly: {
        value: function(row, classMask, readOnly) {
            if (readOnly == undefined) {
                readOnly = true;
            }

            var trash = row.getElementsByClassName('fa-trash-o')[0];
            if (classMask) {
                for (var i = 0; i < classMask.length; ++i) {
                    if (trash.classList.contains(classMask[i])) {
                        trash.classList.toggle('hidden', readOnly);
                        break;
                    }
                }
            } else {
                trash.classList.toggle('hidden', readOnly);
            }

            var inputs = row.getElementsByTagName('input');
            for (var i = 0; i < inputs.length; ++i) {
                if (classMask) {
                    for (var j = 0; j < classMask.length; ++j) {
                        if (inputs[i].classList.contains(classMask[j])) {
                            inputs[i].readOnly = readOnly;
                            break;
                        }
                    }
                } else {
                    inputs[i].readOnly = readOnly;
                }
            }

            var selects = row.getElementsByTagName('select');
            for (var i = 0; i < selects.length; ++i) {
                if (classMask) {
                    for (var j = 0; j < classMask.length; ++j) {
                        if (selects[i].classList.contains(classMask[j])) {
                            selects[i].disabled = readOnly;
                            break;
                        }
                    }
                } else {
                    selects[i].disabled = readOnly;
                }
            }
        }
    },

    clear: {
        value: function() {
            var rowDeletes = this.getElementsByTagName('tbody')[0].getElementsByClassName('fa-trash-o');

            while (rowDeletes.length > 0) {
                rowDeletes[0].click();
            }
        }
    },

    removeRow: {
        value: function(evt) {
            var tr = evt.target.parentElement;
            var tbody = tr.parentElement
            var table = tbody.parentElement;

            /* Remove deletion listener. */
            evt.target.removeEventListener('click', table.removeRow, false);

            /* Now remove row. */
            tbody.removeChild(tr);
        }
    },

    addEmptyRow: {
        value: function(evt) {
            /* Create new row. */
            var table = evt.currentTarget.parentElement.parentElement;
            var rowTemplateId = table.getAttribute('data-template');
            var content = editableTableImportDoc.getElementById(rowTemplateId).content;
            var row = document.importNode(content, true);
            table.getElementsByTagName('tbody')[0].insertBefore(row, evt.currentTarget);
            row = evt.currentTarget.previousElementSibling;

            /* Add deletion listener. */
            row.getElementsByClassName('fa-trash-o')[0].addEventListener('click', table.removeRow, false);
        }
    },

    addRow: {
        value: function(tableData) {
            var rowTemplateId = this.getAttribute('data-template');
            var content = editableTableImportDoc.getElementById(rowTemplateId).content;
            var row = document.importNode(content, true);
            var tbody = this.getElementsByTagName('tbody')[0];
            tbody.insertBefore(row, tbody.lastElementChild);
            row = tbody.lastElementChild.previousElementSibling;

            /* Data is an object with keys that match element class names. */
            for (var key in tableData) {
                var elems = row.getElementsByClassName(key);
                if (tableData[key] != undefined && elems.length == 1) {
                    elems[0].value = tableData[key];
                }
            }

            /* Add deletion listener. */
            row.getElementsByClassName('fa-trash-o')[0].addEventListener('click', this.removeRow, false);

            return row;
        }
    },

    attachedCallback: {
        value: function() {
            /* Add new row listener. */
            this.querySelector('tbody tr:last-child').addEventListener('click', this.addEmptyRow, false);

            /* Add drag 'n' drop listeners.
               Drag 'n' drop should only be enabled for file-row tables.
            */
            if (this.getAttribute('data-template') == 'fileRow') {
                this.addEventListener('drop', this.handleDrop, false);
                this.addEventListener('dragover', this.handleDragOver, false);
            }
        }
    },

    detachedCallback: {
        value: function() {
            /* Remove event listeners. */
            var tbody = this.getElementsByTagName('tbody')[0];

            /* Remove deletion listener. */
            var icons = tbody.getElementsByClassName('fa-trash-o');
            for (var i = 0; i < icons.length; ++i) {
                icons[i].removeEventListener('click', this.removeRow, false);
            }

            /* Remove new row listener. */
            this.querySelector('tbody tr:last-child').removeEventListener('click', this.addEmptyRow, false);

            /* Remove drag 'n' drop listeners. */
            this.removeEventListener('drop', this.handleDrop, false);
            this.removeEventListener('dragover', this.handleDragOver, false);
        }
    },

});
var EditableTable = document.registerElement('editable-table', {
    prototype: EditableTableProto,
    extends: 'table'
});
</script>